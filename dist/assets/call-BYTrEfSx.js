import{A as f}from"./constantes-B-0QMk3S.js";import{l as I}from"./index-BLRFddlS.js";import{l as h}from"./load_navbar-D39noM3e.js";const c=JSON.parse(localStorage.getItem("user")),E=localStorage.getItem("token"),o=I(f,{auth:{token:E,userId:c.id}}),w=new URLSearchParams(window.location.search),u=w.get("user")||"Unknown",g=w.get("room"),O=u.split("_")[1],k=u.split("_")[0];document.getElementById("callUsername").textContent=k;document.getElementById("profilePic").src=`/profiles/user${O}.jpg`;let t,n,i,v=new Date,C={iceServers:[{urls:["stun:stun1.1.google.com:19302","stun:stun2.1.google.com:19302"]}]};const p=e=>new Promise(a=>{if(e.iceGatheringState==="complete")return a();e.addEventListener("icegatheringstatechange",()=>{e.iceGatheringState==="complete"&&a()})}),l=async()=>{n=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),document.getElementById("localVideo").srcObject=n},y=async()=>{n||await l(),t=new RTCPeerConnection(C),i=new MediaStream,document.getElementById("remoteVideo").srcObject=i,n.getTracks().forEach(e=>{t.addTrack(e,n)}),t.ontrack=e=>{e.streams[0].getTracks().forEach(a=>i.addTrack(a))},t.onicecandidate=e=>{e.candidate&&o.emit("candidate",{offer:JSON.stringify({type:"candidate",candidate:e.candidate}),id:c.id})}},T=async e=>{n||await l(),await y();const a=await t.createOffer();await t.setLocalDescription(a),await p(t),console.log("✅ Offer created"),o.emit("sendOffer",{offer:JSON.stringify({type:"offer",offer:t.localDescription}),toSid:e,room:g})},D=async(e,a)=>{await y(),i||(i=new MediaStream,document.getElementById("remoteVideo").srcObject=i),await t.setRemoteDescription(new RTCSessionDescription(e));const r=await t.createAnswer();await t.setLocalDescription(r),await p(t),o.emit("sendAnswer",{answer:JSON.stringify({type:"answer",answer:t.localDescription}),toSid:a,fromSid:c.id,room:g})};o.on("connect",async()=>{console.log("✅ Socket conectado en llamada"),await l(),o.emit("join_room",{room:g,username:c.username})});let m=null;o.on("peer_joined",({sid:e})=>{m=e,console.log("✅ Peer joined with sid:",m),setTimeout(()=>T(m),1e3)});o.on("offer",async({offer:e,fromSid:a})=>{console.log("✅ Received offer from:",a),n||await l();const r=JSON.parse(e).offer;await D(r,a)});let S;o.on("answer",async({answer:e,receiver_id:a})=>{console.log("✅ Received answer");const r=JSON.parse(e).answer;t.signalingState!=="stable"&&await t.setRemoteDescription(new RTCSessionDescription(r)),S=(await(await fetch(`${f}/videoCalls/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({caller_id:c.id,receiver_id:a,started_at:new Date().toISOString()})})).json()).id});o.on("candidate",async({message:e})=>{if(t&&(e!=null&&e.candidate))try{await t.addIceCandidate(e.candidate)}catch(a){console.error("❌ Error adding ICE:",a)}});let s=!0,d=!0;document.getElementById("toggleMic").addEventListener("click",()=>{s=!s,n.getAudioTracks().forEach(e=>e.enabled=s),document.getElementById("micIcon").textContent=s?"🔊":"🔇"});document.getElementById("toggleCam").addEventListener("click",()=>{d=!d,n.getVideoTracks().forEach(e=>e.enabled=d),document.getElementById("camIcon").textContent=d?"🎥":"🚫"});document.getElementById("endCall").addEventListener("click",async()=>{clearInterval(b),n==null||n.getTracks().forEach(a=>a.stop()),t==null||t.close();const e=new Date;await fetch(`${f}/videoCalls/${S}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({ended_at:e.toISOString()})}),window.location.href="main.html"});const b=setInterval(()=>{const e=Math.floor((new Date-v)/1e3),a=Math.floor(e/60).toString().padStart(2,"0"),r=(e%60).toString().padStart(2,"0");document.getElementById("callDuration").textContent=`${a}:${r}`},1e3);h();
